<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
  <link rel="stylesheet" href="./eventy-page.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" />
  <title>Eventy | Hotel Olimp</title>

  <!-- ✅ FIX na kliki + pewne z-indexy -->
  <style>
    [hidden]{ display:none !important; }

    /* modal zapisów */
    #signupModal{ display:none !important; pointer-events:none !important; }
    #signupModal.open{ display:block !important; pointer-events:auto !important; }
    #signupModal .modal__overlay{ cursor:pointer; }

    /* obrazki nie mogą zasłaniać klików */
    .event-media, .event-media *{ pointer-events:none !important; }

    /* przycisk zawsze klikalny */
    .event-card__actions{ position:relative; z-index:5; }
    .btn-primary{ pointer-events:auto !important; cursor:pointer; }
    .btn-primary:disabled{ pointer-events:none !important; cursor:not-allowed; }

    /* nav i panele nad treścią */
    nav{ z-index: 2000; }
    .upanel-overlay{ z-index: 4000; }
    #signupModal{ z-index: 3500; position:fixed; inset:0; }
  </style>
</head>

<body class="events-page">
  <nav>
    <div class="nav__bar">
      <div class="nav__header">
        <div class="logo nav__logo">
          <div>H</div>
          <span>HOTEL<br />Olimp</span>
        </div>
        <button class="nav__menu__btn" id="menu-btn" aria-label="Otwórz menu">
          <i class="ri-menu-line"></i>
        </button>
      </div>

      <div class="nav__right">
        <ul class="nav__links" id="nav--links">
          <li><a href="index.html">Home</a></li>
          <li><a href="onas.html">O nas</a></li>
          <li><a href="pokoje.html">Pokoje</a></li>
          <li><a href="menu.html">Menu</a></li>
          <li><a href="eventy.html" class="active">Eventy</a></li>
          <li><a href="logowanie.html">Logowanie</a></li>
        </ul>

        <button class="nav__userbtn" id="userpanel-btn" type="button" aria-label="Otwórz panel użytkownika">
          <i class="ri-user-3-line"></i>
          <span>Panel</span>
        </button>
      </div>
    </div>
  </nav>

  <header class="events-hero">
    <div class="events-hero__inner">
      <div class="eyebrow">Wypoczynek i atrakcje</div>
      <h1>EVENTY</h1>
      <p>Wybierz wydarzenie i zarezerwuj miejsca. Dostępność aktualizuje się po każdym zapisie.</p>
    </div>
  </header>

  <main class="events-wrap">
    <section class="events-grid" id="eventsGrid"></section>
  </main>

  <!-- MODAL: zapis na event -->
  <div class="modal" id="signupModal" aria-hidden="true" hidden>
    <div class="modal__overlay" id="modalOverlay"></div>

    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal__close" type="button" id="modalClose" aria-label="Zamknij">
        <i class="ri-close-line"></i>
      </button>

      <h2 class="modal__title" id="modalTitle">Zapis na event</h2>
      <p class="modal__subtitle" id="modalSubtitle"></p>

      <form id="signupForm" class="modal__form">
        <div class="form__row">
          <label>Imię</label>
          <input type="text" id="firstName" required maxlength="60" />
        </div>

        <div class="form__row">
          <label>Nazwisko</label>
          <input type="text" id="lastName" required maxlength="80" />
        </div>

        <div class="form__row">
          <label>Liczba osób</label>
          <input type="number" id="peopleCount" min="1" max="20" value="1" required />
          <small class="hint" id="seatsHint"></small>
        </div>

        <div class="form__row">
          <label>Godzina</label>
          <select id="slotSelect" required></select>
        </div>

        <button class="btn-primary" type="submit" id="submitBtn">Zapisz się</button>
        <div class="form__msg" id="formMsg"></div>
      </form>
    </div>
  </div>

  <!-- USER PANEL (modal) -->
  <div class="upanel-overlay" id="upanel-overlay" hidden>
    <div class="upanel" role="dialog" aria-modal="true" aria-labelledby="upanel-title">
      <button class="upanel__close" id="upanel-close" aria-label="Zamknij">
        <i class="ri-close-line"></i>
      </button>

      <div class="upanel__header">
        <div>
          <div class="upanel__eyebrow">Panel użytkownika</div>
          <h2 id="upanel-title">Witaj, <span id="upanel-login">…</span></h2>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <a class="btn btn--outline" id="upanel-loginlink" href="logowanie.html" style="display:none">Zaloguj</a>
          <button class="btn btn--outline" id="upanel-logout" type="button" style="display:none">Wyloguj</button>
        </div>
      </div>

      <div class="upanel__grid">
        <section class="upanel__section">
          <h3>Najbliższe rezerwacje</h3>
          <div id="upanel-reservations"></div>
        </section>

        <section class="upanel__section">
          <h3>Najbliższe eventy</h3>
          <div id="upanel-events"></div>
        </section>
      </div>

      <p class="upanel__hint" id="upanel-hint"></p>
    </div>
  </div>

<script>
  // Jeśli odpalasz z express.static -> zostaw ""
  // Jeśli odpalasz jako plik -> ustaw "http://localhost:3000"
  const API = "";

  async function request(url, opts = {}){
    try{
      const headers = { ...(opts.headers || {}) };
      const hasBody = !!opts.body;

      // Content-Type ustawiaj tylko gdy naprawdę wysyłasz body
      if (hasBody && !headers["Content-Type"]) headers["Content-Type"] = "application/json";

      const r = await fetch(API + url, {
        credentials: "include",
        ...opts,
        headers
      });

      let body = {};
      try { body = await r.json(); } catch(e){}
      return { ok: r.ok, status: r.status, body };
    }catch(err){
      return { ok:false, status:0, body:{ error:"Brak połączenia z backendem" } };
    }
  }

  // hamburger
  (function(){
    const btn = document.getElementById("menu-btn");
    const links = document.getElementById("nav--links");
    if (btn && links) btn.addEventListener("click", () => links.classList.toggle("open"));
  })();

  // ===== obrazki: próbuj jpg -> png -> webp -> jpeg, a na końcu OGNI SKO =====
  window.__imgFallback = function(img){
    const exts = ["jpg","png","webp","jpeg"];
    let base = img.getAttribute("data-base");
    if(!base) base = "/images/ognisko";

    let i = Number(img.getAttribute("data-try") || "0");
    i++;

    if(i >= exts.length){
      img.onerror = null;
      img.src = "/images/ognisko.jpg"; // ✅ fallback OGNI SKO
      return;
    }
    img.setAttribute("data-try", String(i));
    img.src = `${base}.${exts[i]}`;
  };

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtTime(s){
    if(!s) return "";
    const str = String(s);
    const d = new Date(str);
    if(!Number.isNaN(d.getTime())){
      return d.toLocaleString("pl-PL", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    return str.slice(0,5);
  }

  // ✅ dopasowanie zdjęć do Twoich plików: aqua/joga/wino/rower/pokaz/ognisko/muzyka/siatka
  function pickPhotoBase(ev){
    const t = (ev.title || "").toLowerCase();

    if (t.includes("aqua") || t.includes("basen") || t.includes("aquapark")) return "/images/aqua";
    if (t.includes("joga") || t.includes("yoga")) return "/images/joga";
    if (t.includes("wino") || t.includes("degust") || t.includes("sommel")) return "/images/wino";
    if (t.includes("rower") || t.includes("bike") || t.includes("wyciecz")) return "/images/rower";
    if (t.includes("pokaz") || t.includes("show")) return "/images/pokaz";
    if (t.includes("ognisko") || t.includes("grill") || t.includes("fire")) return "/images/ognisko";
    if (t.includes("muzyk") || t.includes("koncert") || t.includes("dj")) return "/images/muzyka";
    if (t.includes("siat") || t.includes("volley")) return "/images/siatka";

    return "/images/ognisko"; // ✅ domyślnie OGNI SKO
  }

  // ====== MODAL ZAPISU ======
  const signupModal  = document.getElementById("signupModal");
  const modalClose   = document.getElementById("modalClose");
  const modalOverlay = document.getElementById("modalOverlay");
  const modalSubtitle= document.getElementById("modalSubtitle");

  const signupForm   = document.getElementById("signupForm");
  const firstNameEl  = document.getElementById("firstName");
  const lastNameEl   = document.getElementById("lastName");
  const peopleCountEl= document.getElementById("peopleCount");
  const seatsHintEl  = document.getElementById("seatsHint");
  const slotSelectEl = document.getElementById("slotSelect");
  const submitBtn    = document.getElementById("submitBtn");
  const formMsg      = document.getElementById("formMsg");

  function openModal(){
    signupModal.hidden = false;
    signupModal.classList.add("open");
    signupModal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    signupModal.classList.remove("open");
    signupModal.setAttribute("aria-hidden","true");
    signupModal.hidden = true;
    document.body.style.overflow = "";
  }

  modalClose.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", closeModal);
  window.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && !signupModal.hidden) closeModal(); });

  const grid = document.getElementById("eventsGrid");

  const state = {
    eventsById: new Map(),
    currentEventId: null,
    slots: []
  };

  function renderSlots(){
    slotSelectEl.innerHTML = "";
    const slots = state.slots || [];

    if(!slots.length){
      slotSelectEl.innerHTML = `<option value="" disabled selected>Brak slotów</option>`;
      seatsHintEl.textContent = "";
      submitBtn.disabled = true;
      return;
    }

    slots.forEach(s => {
      const disabled = Number(s.remaining) <= 0;
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${fmtTime(s.slot_time)} • wolne: ${s.remaining}`;
      if(disabled) opt.disabled = true;
      slotSelectEl.appendChild(opt);
    });

    const firstEnabled = Array.from(slotSelectEl.options).find(o => !o.disabled);
    if(firstEnabled) slotSelectEl.value = firstEnabled.value;

    submitBtn.disabled = !firstEnabled;
    updateSeatsHint();
  }

  function updateSeatsHint(){
    const slotId = Number(slotSelectEl.value);
    const slot = (state.slots || []).find(s => Number(s.id) === slotId);
    if(!slot){ seatsHintEl.textContent = ""; return; }

    const rem = Number(slot.remaining || 0);
    seatsHintEl.textContent = `Dostępne miejsca w tym slocie: ${rem}`;
    const pc = Number(peopleCountEl.value || 1);
    submitBtn.disabled = (pc < 1 || pc > rem);
  }

  peopleCountEl.addEventListener("input", updateSeatsHint);
  slotSelectEl.addEventListener("change", updateSeatsHint);

  function eventCardHTML(ev){
    const title = escapeHtml(ev.title || "");
    const desc  = escapeHtml(ev.description || "");
    const slots = Array.isArray(ev.slots) ? ev.slots : [];
    const base  = pickPhotoBase(ev);

    const maxRemaining = slots.length ? Math.max(...slots.map(s => Number(s.remaining || 0))) : 0;

    return `
      <article class="event-card">
        <div class="event-media">
          <img class="event-img"
               data-base="${base}"
               data-try="0"
               src="${base}.jpg"
               alt="${title}"
               loading="lazy"
               onerror="__imgFallback(this)">
        </div>

        <div class="event-card__top">
          <h3>${title}</h3>
          <div class="event-card__meta">
            Sloty: <b>${slots.length}</b> • Dostępność: <b>${maxRemaining > 0 ? "jest" : "brak miejsc"}</b>
          </div>
        </div>

        <p class="event-card__desc">${desc}</p>

        <div class="event-card__actions">
          <button class="btn-primary js-signup" type="button" data-event-id="${escapeHtml(ev.id)}">
            Zapisz się
          </button>
        </div>
      </article>
    `;
  }

  async function loadEvents(){
    grid.innerHTML = "Ładowanie...";
    const res = await request("/api/events", { method:"GET" });

    if(!res.ok){
      grid.innerHTML = `<div style="color:#fff;font-family:system-ui">Błąd: ${res.body?.error || "nieznany"}</div>`;
      return;
    }

    const events = res.body?.events || [];
    if(!events.length){
      grid.innerHTML = "Brak eventów.";
      return;
    }

    state.eventsById = new Map(events.map(e => [String(e.id), e]));
    grid.innerHTML = events.map(eventCardHTML).join("");
  }

  // ✅ klik “Zapisz się” działa zawsze (delegacja)
  grid.addEventListener("click", async (e) => {
    const btn = e.target.closest(".js-signup");
    if(!btn) return;

    const me = await request("/api/auth/me", { method:"GET" });
    if(!me.ok){
      window.location.href = "logowanie.html";
      return;
    }

    const id = String(btn.dataset.eventId || "");
    const ev = state.eventsById.get(id);
    if(!ev){
      alert("Nie udało się odczytać eventu.");
      return;
    }

    state.currentEventId = ev.id;
    state.slots = Array.isArray(ev.slots) ? ev.slots : [];

    modalSubtitle.textContent = ev.title || "Event";
    signupForm.reset();
    peopleCountEl.value = 1;
    formMsg.textContent = "";
    formMsg.style.color = "";
    renderSlots();
    openModal();
    firstNameEl.focus();
  });

  signupForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    formMsg.textContent = "";

    const eventId = state.currentEventId;
    const slotId = Number(slotSelectEl.value);
    const firstName = firstNameEl.value.trim();
    const lastName = lastNameEl.value.trim();
    const peopleCount = Number(peopleCountEl.value || 1);

    const slot = (state.slots || []).find(s => Number(s.id) === slotId);
    const rem = Number(slot?.remaining || 0);

    if(!eventId || !slotId){
      formMsg.textContent = "Wybierz godzinę (slot).";
      formMsg.style.color = "#b91c1c";
      return;
    }
    if(firstName.length < 2 || lastName.length < 2){
      formMsg.textContent = "Podaj imię i nazwisko (min. 2 znaki).";
      formMsg.style.color = "#b91c1c";
      return;
    }
    if(peopleCount > rem){
      formMsg.textContent = `Za dużo osób. Dostępne: ${rem}.`;
      formMsg.style.color = "#b91c1c";
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Zapisywanie...";

    const res = await request(`/api/events/${eventId}/signup`, {
      method:"POST",
      body: JSON.stringify({ firstName, lastName, peopleCount, slotId })
    });

    submitBtn.disabled = false;
    submitBtn.textContent = "Zapisz się";

    if(!res.ok){
      formMsg.textContent = res.body?.error || "Nie udało się zapisać.";
      formMsg.style.color = "#b91c1c";
      return;
    }

    formMsg.textContent = "Zapisano ✅";
    formMsg.style.color = "#065f46";

    await loadEvents();
    if(!upOverlay.hidden) loadUserPanel();

    setTimeout(closeModal, 600);
  });

  // ===== USER PANEL =====
  const upOverlay = document.getElementById("upanel-overlay");
  const upOpenBtn = document.getElementById("userpanel-btn");
  const upCloseBtn = document.getElementById("upanel-close");
  const upLoginEl = document.getElementById("upanel-login");
  const upHintEl = document.getElementById("upanel-hint");
  const upResEl = document.getElementById("upanel-reservations");
  const upEventsEl = document.getElementById("upanel-events");
  const upLoginLink = document.getElementById("upanel-loginlink");
  const upLogoutBtn = document.getElementById("upanel-logout");

  function userItemHTML(icon, title, sub){
    return `
      <div class="upanel__item">
        <div class="upanel__icon"><i class="${icon}"></i></div>
        <div class="upanel__meta">
          <div class="upanel__title">${escapeHtml(title)}</div>
          <div class="upanel__sub">${escapeHtml(sub)}</div>
        </div>
      </div>
    `;
  }
  function renderEmpty(where, text){
    where.innerHTML = userItemHTML("ri-information-line", text, "Brak danych do wyświetlenia");
  }
  function setLoggedOut(msg){
    upLoginEl.textContent = "gościu";
    upLoginLink.style.display = "inline-block";
    upLogoutBtn.style.display = "none";
    upHintEl.textContent = msg || "Zaloguj się, żeby zobaczyć swoje rezerwacje i zapisy.";
    renderEmpty(upResEl, "Rezerwacje");
    renderEmpty(upEventsEl, "Eventy");
  }
  function setLoggedIn(login){
    upLoginEl.textContent = login || "użytkowniku";
    upLoginLink.style.display = "none";
    upLogoutBtn.style.display = "inline-block";
  }

  async function loadUserPanel(){
    upHintEl.textContent = "Ładowanie...";
    upResEl.innerHTML = "";
    upEventsEl.innerHTML = "";

    const me = await request("/api/auth/me", { method:"GET" });
    if (!me.ok || !me.body?.user){
      setLoggedOut(me.body?.error || "Brak sesji.");
      return;
    }
    setLoggedIn(me.body.user.login);

    const dash = await request("/api/user/dashboard", { method:"GET" });
    if(!dash.ok){
      upHintEl.textContent = dash.body?.error || "Nie udało się pobrać panelu.";
      renderEmpty(upResEl, "Rezerwacje");
      renderEmpty(upEventsEl, "Eventy");
      return;
    }

    const reservations = Array.isArray(dash.body?.reservations) ? dash.body.reservations : [];
    const events = Array.isArray(dash.body?.events) ? dash.body.events : [];

    if(!reservations.length){
      renderEmpty(upResEl, "Brak najbliższych rezerwacji");
    } else {
      upResEl.innerHTML = reservations.slice(0,5).map(r =>
        userItemHTML(
          "ri-hotel-bed-line",
          `Pokój ${r.room_number ?? ""} • ${r.room_type ?? ""}`.trim(),
          `${String(r.check_in ?? "").slice(0,10)} → ${String(r.check_out ?? "").slice(0,10)} • ${r.status ?? ""}`
        )
      ).join("");
    }

    if(!events.length){
      renderEmpty(upEventsEl, "Brak zapisów na eventy");
    } else {
      upEventsEl.innerHTML = events.slice(0,5).map(e =>
        userItemHTML(
          "ri-calendar-event-line",
          e.title ?? "Event",
          `Start: ${String(e.start_at ?? "").slice(0,16)} • osób: ${e.people_count ?? ""}`.trim()
        )
      ).join("");
    }

    upHintEl.textContent = "Panel działa.";
  }

  function openUserPanel(){
    upOverlay.hidden = false;
    document.body.style.overflow = "hidden";
    loadUserPanel();
  }
  function closeUserPanel(){
    upOverlay.hidden = true;
    document.body.style.overflow = "";
  }

  upOpenBtn?.addEventListener("click", openUserPanel);
  upCloseBtn?.addEventListener("click", closeUserPanel);
  upOverlay?.addEventListener("click", (e)=>{ if(e.target === upOverlay) closeUserPanel(); });
  window.addEventListener("keydown", (e)=>{ if(!upOverlay.hidden && e.key === "Escape") closeUserPanel(); });

  upLogoutBtn?.addEventListener("click", async ()=>{
    await request("/api/auth/logout", { method:"POST" });
    setLoggedOut("Wylogowano.");
  });

  // START
  loadEvents();
</script>

</body>
</html>
